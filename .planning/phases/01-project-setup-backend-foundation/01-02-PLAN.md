---
phase: 01-project-setup-backend-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/server/src/app.ts
  - packages/server/src/server.ts
  - packages/server/src/plugins/db.ts
  - packages/server/src/plugins/storage.ts
  - packages/server/src/routes/health.ts
  - packages/server/src/utils/storage.ts
autonomous: true

must_haves:
  truths:
    - "Fastify server starts on configured port and logs startup message"
    - "GET /health returns 200 with uptime and status info"
    - "Prisma connects to SQLite database on server startup"
    - "Prisma disconnects cleanly on server shutdown"
    - "Storage directories (images/, thumbnails/) are created on startup if missing"
    - "Writing a test file to storage directory succeeds"
  artifacts:
    - path: "packages/server/src/app.ts"
      provides: "Fastify app builder with plugin registration"
      exports: ["build"]
    - path: "packages/server/src/server.ts"
      provides: "Server bootstrap and startup"
      min_lines: 15
    - path: "packages/server/src/plugins/db.ts"
      provides: "Prisma database plugin for Fastify"
      exports: ["default"]
    - path: "packages/server/src/plugins/storage.ts"
      provides: "Storage directory initialization plugin"
      exports: ["default"]
    - path: "packages/server/src/routes/health.ts"
      provides: "Health check route"
      exports: ["default"]
    - path: "packages/server/src/utils/storage.ts"
      provides: "Storage path helper functions"
      exports: ["getImagePath", "getThumbnailPath", "getStorageBasePath"]
  key_links:
    - from: "packages/server/src/app.ts"
      to: "packages/server/src/plugins/db.ts"
      via: "fastify.register(dbPlugin)"
      pattern: "register.*db"
    - from: "packages/server/src/plugins/db.ts"
      to: "@prisma/client"
      via: "PrismaClient instantiation and fastify.decorate"
      pattern: "new PrismaClient"
    - from: "packages/server/src/app.ts"
      to: "packages/server/src/routes/health.ts"
      via: "fastify.register(healthRoutes)"
      pattern: "register.*health"
    - from: "packages/server/src/server.ts"
      to: "packages/server/src/app.ts"
      via: "import { build } from './app'"
      pattern: "build"
---

<objective>
Build the Fastify API server with database plugin, storage initialization, and health check endpoint.

Purpose: This is the running server that all API features (image upload, tag management, search) will be built on. The health check proves the server, database, and storage are all wired correctly.
Output: A running Fastify server at localhost:3000 with /health endpoint, Prisma database connection, and initialized storage directories.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-setup-backend-foundation/01-RESEARCH.md
@.planning/phases/01-project-setup-backend-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fastify server with database and storage plugins</name>
  <files>
    packages/server/src/app.ts
    packages/server/src/server.ts
    packages/server/src/plugins/db.ts
    packages/server/src/plugins/storage.ts
    packages/server/src/utils/storage.ts
  </files>
  <action>
    1. Create `packages/server/src/plugins/db.ts`:
       - Import fastify-plugin and PrismaClient
       - Create plugin that instantiates PrismaClient with log: ['error', 'warn']
       - Call prisma.$connect() to verify connection
       - Decorate fastify instance with prisma
       - Add onClose hook to call prisma.$disconnect()
       - Add TypeScript declaration merging for FastifyInstance.prisma
       - Export as default wrapped in fp()

    2. Create `packages/server/src/utils/storage.ts`:
       - getStorageBasePath(): returns process.env.STORAGE_PATH || './storage'
       - getImagePath(hash: string): returns path using 2-char hash prefix subdirectory under images/
       - getThumbnailPath(hash: string): returns path using 2-char hash prefix subdirectory under thumbnails/
       - All paths use path.join for cross-platform compatibility

    3. Create `packages/server/src/plugins/storage.ts`:
       - Import fastify-plugin, mkdir from fs/promises
       - Create plugin that ensures storage/images/ and storage/thumbnails/ directories exist (recursive: true)
       - Use getStorageBasePath() from utils/storage.ts
       - Log directory creation
       - Export as default wrapped in fp()

    4. Create `packages/server/src/app.ts`:
       - Export async function build(opts) that creates Fastify instance with logger config
       - Register @fastify/cors with origin: process.env.CLIENT_URL || 'http://localhost:5173'
       - Register dbPlugin (BEFORE routes — per research pitfall #3)
       - Register storagePlugin
       - Register healthRoutes with prefix '/health'
       - Return app instance

    5. Create `packages/server/src/server.ts`:
       - Import build from ./app
       - Import dotenv/config or use Bun.env (bun loads .env automatically)
       - Call build(), then listen on port from env (default 3000), host '0.0.0.0'
       - Log startup message with port
       - Handle startup errors with process.exit(1)

    Important: Use `fastify-plugin` (fp) wrapper for db and storage plugins so decorators are accessible in the parent scope. Without fp(), decorators are scoped to the plugin's encapsulation context.
  </action>
  <verify>
    - `bunx tsc --noEmit -p packages/server/tsconfig.json` passes
    - `bun packages/server/src/server.ts` starts without errors (run briefly, then Ctrl+C)
    - Server logs show "Server listening on port 3000" or similar
  </verify>
  <done>
    Fastify server starts, connects to Prisma/SQLite, creates storage directories, and is ready to accept requests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Health check endpoint and end-to-end verification</name>
  <files>
    packages/server/src/routes/health.ts
  </files>
  <action>
    1. Create `packages/server/src/routes/health.ts`:
       - Export default async function as Fastify plugin (using fastify-plugin is NOT needed here — route plugins should be encapsulated)
       - Register GET / route (will be mounted at /health prefix from app.ts)
       - Handler queries prisma with a simple `SELECT 1` raw query to verify DB connection
       - Handler checks storage directory exists using fs.access
       - Returns JSON: { status: "ok", uptime: process.uptime(), database: "connected", storage: "ready", timestamp: new Date().toISOString() }
       - If DB or storage check fails, return 503 with status: "degraded" and details

    2. Verify the full stack works:
       - Start server in background
       - curl http://localhost:3000/health
       - Verify response has status: "ok", database: "connected", storage: "ready"
       - Stop server

    3. Write a test file to storage directory to prove write access:
       - Create a small test: write a temp file to storage/images/, verify it exists, delete it
       - This can be done via a quick bun script or inline in the verification step
  </action>
  <verify>
    - Start server: `bun packages/server/src/server.ts &`
    - `curl -s http://localhost:3000/health | jq .` returns { status: "ok", database: "connected", storage: "ready", ... }
    - `curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health` returns 200
    - Kill server process
    - storage/images/ and storage/thumbnails/ directories exist
  </verify>
  <done>
    GET /health returns 200 with status "ok", confirming database connection and storage readiness. Storage directories exist and accept file writes. Phase 1 success criteria are fully met.
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria verification:
1. Monorepo workspace structure exists with shared types accessible across packages — verified by tsc --noEmit passing and workspace:* resolution
2. Database schema is created with Prisma migrations applied successfully — verified by prisma migrate status
3. Fastify API server starts and responds to health check endpoint — verified by curl /health returning 200
4. File storage directory structure exists and accepts test file writes — verified by storage directories existing and health check reporting storage: "ready"
</verification>

<success_criteria>
- Server starts on port 3000 without errors
- GET /health returns 200 with JSON body containing status: "ok"
- Health check confirms database: "connected" and storage: "ready"
- Storage directories (storage/images/, storage/thumbnails/) are auto-created on startup
- Server shuts down cleanly (Prisma disconnects, no hanging processes)
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-backend-foundation/01-02-SUMMARY.md`
</output>
