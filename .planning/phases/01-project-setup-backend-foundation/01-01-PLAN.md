---
phase: 01-project-setup-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bunfig.toml
  - tsconfig.json
  - tsconfig.base.json
  - .gitignore
  - .env
  - .env.example
  - packages/shared/package.json
  - packages/shared/tsconfig.json
  - packages/shared/src/index.ts
  - packages/shared/src/image.ts
  - packages/shared/src/tag.ts
  - packages/shared/src/api.ts
  - packages/server/package.json
  - packages/server/tsconfig.json
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "bun install resolves workspace packages without errors"
    - "TypeScript compiles across all packages with no errors"
    - "@emohub/shared types are importable from packages/server"
    - "Prisma migration creates SQLite database with Image, Tag, and ImageTag tables"
    - "Prisma Client generates typed query methods for all models"
  artifacts:
    - path: "packages/shared/src/index.ts"
      provides: "Re-exports all shared types"
      exports: ["Image", "Tag", "ImageTag", "ApiResponse", "PaginatedResponse"]
    - path: "packages/shared/src/image.ts"
      provides: "Image-related TypeScript types"
      exports: ["Image", "CreateImageInput", "ImageWithTags"]
    - path: "packages/shared/src/tag.ts"
      provides: "Tag-related TypeScript types"
      exports: ["Tag", "CreateTagInput", "TagCategory"]
    - path: "packages/shared/src/api.ts"
      provides: "API response envelope types"
      exports: ["ApiResponse", "PaginatedResponse", "ApiError"]
    - path: "prisma/schema.prisma"
      provides: "Database schema with Image, Tag, ImageTag models"
      contains: "model Image"
  key_links:
    - from: "packages/server/package.json"
      to: "@emohub/shared"
      via: "workspace:* dependency"
      pattern: '"@emohub/shared":\\s*"workspace:\\*"'
    - from: "prisma/schema.prisma"
      to: "SQLite database"
      via: "datasource db provider sqlite"
      pattern: 'provider\\s*=\\s*"sqlite"'
---

<objective>
Set up the turbo monorepo foundation: workspace configuration, shared TypeScript types package, and Prisma database schema with migrations.

Purpose: All subsequent work (server, web app, features) depends on having a working monorepo with shared types and a database schema. This is the absolute foundation.
Output: Working bun workspace with @emohub/shared package, Prisma schema with Image/Tag/ImageTag models, and applied SQLite migration.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-setup-backend-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Monorepo configuration and shared types package</name>
  <files>
    package.json
    bunfig.toml
    tsconfig.json
    tsconfig.base.json
    .gitignore
    .env
    .env.example
    packages/shared/package.json
    packages/shared/tsconfig.json
    packages/shared/src/index.ts
    packages/shared/src/image.ts
    packages/shared/src/tag.ts
    packages/shared/src/api.ts
    packages/server/package.json
    packages/server/tsconfig.json
  </files>
  <action>
    1. Create `bunfig.toml` at root with isolated linker mode:
       ```toml
       [install]
       linker = "isolated"
       ```

    2. Create `tsconfig.base.json` at root with shared compiler options:
       - target: ES2022, module: ESNext, moduleResolution: bundler
       - strict: true, esModuleInterop: true, skipLibCheck: true
       - declaration: true, declarationMap: true, sourceMap: true

    3. Create root `tsconfig.json` that extends base and sets up project references for packages/shared and packages/server.

    4. Update root `package.json`:
       - Add "packages/shared" to workspaces array (currently only has "packages/server" and "apps/*")
       - Add scripts: "dev:server", "db:migrate", "db:generate", "db:push", "typecheck"
       - Add "type": "module"

    5. Create `packages/shared/package.json`:
       - name: "@emohub/shared"
       - main: "src/index.ts", types: "src/index.ts"
       - type: "module"

    6. Create `packages/shared/tsconfig.json` extending ../../tsconfig.base.json, include src/**.

    7. Create shared type files:
       - `packages/shared/src/image.ts`: Types for Image entity (id, filename, originalName, mimeType, size, width, height, hash, createdAt, updatedAt), CreateImageInput (omit auto fields), ImageWithTags (Image with tags array).
       - `packages/shared/src/tag.ts`: Types for Tag entity (id, name, category, createdAt), CreateTagInput (name, category?), TagCategory enum type ("character" | "series" | "keyword" | "other").
       - `packages/shared/src/api.ts`: ApiResponse<T> envelope with success, data?, error?, meta?. PaginatedResponse<T> extending with total, page, limit. ApiError type.
       - `packages/shared/src/index.ts`: Re-export everything from image.ts, tag.ts, api.ts.

    8. Update `packages/server/package.json`:
       - Add name: "@emohub/server"
       - Add "@emohub/shared": "workspace:*" to dependencies
       - Add "fastify-plugin": "^5.0.0" to dependencies (needed for plugin pattern)
       - Add "type": "module"
       - Add scripts: "dev": "bun --watch src/server.ts", "start": "bun src/server.ts"
       - Remove sqlite3 dependency (using better-sqlite3 via Prisma, not needed directly)

    9. Create `packages/server/tsconfig.json` extending ../../tsconfig.base.json, include src/**.

    10. Update `.gitignore`: Add entries for storage/, *.db, *.db-journal, *.db-wal, .env, prisma/migrations (keep tracked but ignore generated), dist/, .bun-cache.

    11. Create `.env.example` with DATABASE_URL, PORT, STORAGE_PATH, LOG_LEVEL placeholders.
    12. Create `.env` with actual dev values: DATABASE_URL="file:./prisma/dev.db", PORT=3000, STORAGE_PATH="./storage", LOG_LEVEL="info".

    13. Run `bun install` to link workspace packages.
  </action>
  <verify>
    - `bun install` completes without errors
    - `bunx tsc --noEmit -p packages/shared/tsconfig.json` passes
    - In packages/server, `import type { Image } from '@emohub/shared'` resolves (verify with a quick tsc check)
  </verify>
  <done>
    Monorepo workspace is configured. @emohub/shared package exports Image, Tag, ImageTag, ApiResponse types. packages/server can import from @emohub/shared. TypeScript compiles cleanly across all packages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Prisma schema and database migration</name>
  <files>
    prisma/schema.prisma
  </files>
  <action>
    1. Create `prisma/schema.prisma` with:
       - generator client: provider "prisma-client-js"
       - datasource db: provider "sqlite", url env("DATABASE_URL")
       - model Image: id (String @id @default(cuid())), filename (String), originalName (String), mimeType (String), size (Int), width (Int), height (Int), hash (String @unique), storagePath (String), thumbnailPath (String?), createdAt (DateTime @default(now())), updatedAt (DateTime @updatedAt), tags (ImageTag[])
       - model Tag: id (String @id @default(cuid())), name (String @unique), category (String? @default("keyword")), createdAt (DateTime @default(now())), images (ImageTag[])
       - model ImageTag: imageId (String), tagId (String), createdAt (DateTime @default(now())), image relation with onDelete Cascade, tag relation with onDelete Cascade, @@id([imageId, tagId]), @@index([tagId])

    2. Run `bunx prisma migrate dev --name init` to create initial migration and generate client.

    3. Run `bunx prisma generate` to ensure client types are up to date.

    Note: The schema uses explicit many-to-many (ImageTag) per research recommendation, allowing future metadata on the relationship. The hash field has a unique constraint for duplicate detection (IMG-07). storagePath and thumbnailPath fields store the relative path within the storage directory.
  </action>
  <verify>
    - `bunx prisma migrate status` shows no pending migrations
    - `bunx prisma validate` passes
    - SQLite database file exists at prisma/dev.db
    - `bunx prisma db execute --stdin <<< "SELECT name FROM sqlite_master WHERE type='table';"` shows Image, Tag, ImageTag tables
  </verify>
  <done>
    Prisma schema defines Image, Tag, and ImageTag models. Migration is applied to SQLite database. Prisma Client is generated with typed query methods for all models.
  </done>
</task>

</tasks>

<verification>
- `bun install` succeeds with no unresolved workspace dependencies
- `bunx tsc --noEmit` passes for both shared and server packages
- `bunx prisma validate` passes
- `bunx prisma migrate status` shows all migrations applied
- SQLite database contains Image, Tag, ImageTag tables
</verification>

<success_criteria>
- Monorepo workspace resolves all internal dependencies
- Shared types are importable from @emohub/shared in server package
- Database schema matches the Image/Tag/ImageTag model design
- Prisma Client generates without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-backend-foundation/01-01-SUMMARY.md`
</output>
