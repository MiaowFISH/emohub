---
phase: 08-enhanced-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/src/routes/__root.tsx
  - apps/web/src/lib/clipboard.ts
  - apps/web/src/components/ImageLightbox.tsx
  - apps/web/src/components/ImageToolbar.tsx
  - apps/web/public/locales/en/images.json
  - apps/web/public/locales/zh/images.json
  - apps/web/public/locales/en/common.json
  - apps/web/public/locales/zh/common.json
autonomous: true

must_haves:
  truths:
    - "User can click a copy button in the lightbox to copy the current image to clipboard"
    - "User can choose between copying as original (PNG) or converting to GIF before copying"
    - "User sees a toast notification confirming copy success or explaining failure"
    - "Existing alert() calls in ImageToolbar are replaced with toast notifications"
  artifacts:
    - path: "apps/web/src/lib/clipboard.ts"
      provides: "Clipboard copy utility with PNG conversion and GIF support"
      exports: ["copyImageToClipboard"]
    - path: "apps/web/src/components/ImageLightbox.tsx"
      provides: "Lightbox with copy button and format selector"
      contains: "copyImageToClipboard"
  key_links:
    - from: "apps/web/src/components/ImageLightbox.tsx"
      to: "apps/web/src/lib/clipboard.ts"
      via: "import copyImageToClipboard"
      pattern: "import.*clipboard"
    - from: "apps/web/src/components/ImageLightbox.tsx"
      to: "sonner"
      via: "toast notifications for copy feedback"
      pattern: "toast\\.(success|error|loading)"
    - from: "apps/web/src/routes/__root.tsx"
      to: "sonner"
      via: "Toaster provider component"
      pattern: "<Toaster"
---

<objective>
Add clipboard copy functionality to the image lightbox with format selection (original PNG or GIF) and toast notification feedback.

Purpose: Users need to quickly copy emoji/sticker images to their system clipboard for pasting into chat apps. This is a core workflow for an emoji management tool.
Output: Clipboard utility module, copy button in lightbox, toast notification system integrated app-wide.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-enhanced-operations/08-RESEARCH.md
@apps/web/src/components/ImageLightbox.tsx
@apps/web/src/components/ImageToolbar.tsx
@apps/web/src/lib/api.ts
@apps/web/src/routes/__root.tsx
@apps/web/public/locales/en/images.json
@apps/web/public/locales/zh/images.json
@apps/web/public/locales/en/common.json
@apps/web/public/locales/zh/common.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sonner, create clipboard utility, add Toaster provider</name>
  <files>
    apps/web/package.json
    apps/web/src/lib/clipboard.ts
    apps/web/src/routes/__root.tsx
    apps/web/src/components/ImageToolbar.tsx
    apps/web/public/locales/en/images.json
    apps/web/public/locales/zh/images.json
    apps/web/public/locales/en/common.json
    apps/web/public/locales/zh/common.json
  </files>
  <action>
    1. Install sonner: `cd apps/web && bun add sonner`

    2. Create `apps/web/src/lib/clipboard.ts` with:
       - `copyImageToClipboard(imageUrl: string, format: 'original' | 'gif', gifConvertFn?: (url: string) => Promise<Blob>)` async function
       - For 'original' format: fetch the image, convert to PNG via canvas (Clipboard API mandates PNG), write via `navigator.clipboard.write([new ClipboardItem({ 'image/png': pngBlob })])`
       - For 'gif' format: if `gifConvertFn` provided, call it to get GIF blob, then write to clipboard. The gifConvertFn should use the existing `imageApi.convertToGif(id)` server endpoint (NOT client-side gif.js — the server already handles GIF conversion)
       - Return `{ success: true }` or `{ success: false, error: string }` with specific error messages for: permission denied, clipboard API unavailable, fetch failure, conversion failure
       - Helper `convertToPng(blob: Blob): Promise<Blob>` — draws image to canvas, exports as PNG blob
       - Check `navigator.clipboard` existence before attempting write

    3. Add `<Toaster />` from sonner to `__root.tsx`:
       - Import `{ Toaster }` from 'sonner'
       - Place `<Toaster position="bottom-center" richColors />` inside the root layout div, after `<main>`
       - The Toaster will respect the existing CSS variable theming via its `theme` prop — pass `theme="system"` so it follows the data-theme attribute

    4. Replace `alert()` calls in `ImageToolbar.tsx` with `toast.error()` from sonner:
       - Line 27: `alert(t('toolbar.delete_failed'...))` → `toast.error(t('toolbar.delete_failed'...))`
       - Line 64: `alert(...)` → `toast.error(t('toolbar.convert_failed'...))` (add new translation key)
       - Import `{ toast }` from 'sonner'

    5. Add clipboard and toast translation keys to all 4 locale files:
       - EN images.json — add `"clipboard"` section: `copy`, `copy_original`, `copy_as_gif`, `copying`, `copy_success`, `copy_failed`, `permission_denied`, `not_supported`
       - ZH images.json — add matching `"clipboard"` section with Chinese translations
       - EN common.json — add `"status.copying": "Copying..."`
       - ZH common.json — add `"status.copying": "复制中..."`
       - EN images.json — add `"toolbar.convert_failed": "Failed to convert image: {{error}}"`
       - ZH images.json — add `"toolbar.convert_failed": "转换图片失败：{{error}}"`
  </action>
  <verify>
    - `cd apps/web && bun run build` completes without errors
    - `grep -r "alert(" apps/web/src/components/ImageToolbar.tsx` returns no results (all alerts replaced)
    - `grep "Toaster" apps/web/src/routes/__root.tsx` confirms Toaster is mounted
    - `grep "copyImageToClipboard" apps/web/src/lib/clipboard.ts` confirms utility exists
  </verify>
  <done>
    Sonner installed, clipboard utility created with PNG conversion and error handling, Toaster provider mounted in root layout, all alert() calls in ImageToolbar replaced with toast.error(), translation keys added for clipboard operations in both languages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add copy button with format selector to ImageLightbox</name>
  <files>
    apps/web/src/components/ImageLightbox.tsx
  </files>
  <action>
    Modify `ImageLightbox.tsx` to add a copy button with format selection:

    1. Import `{ toast }` from 'sonner', `{ copyImageToClipboard }` from '@/lib/clipboard', `{ imageApi }` from '@/lib/api', `{ useTranslation }` from 'react-i18next', and `useState`

    2. Add state: `const [copyFormat, setCopyFormat] = useState<'original' | 'gif'>('original')`

    3. Create `handleCopy` async function:
       - Get current image URL via `imageApi.getFullUrl(currentImage.id)`
       - Show loading toast: `const toastId = toast.loading(t('clipboard.copying'))`
       - If format is 'gif': call `copyImageToClipboard(url, 'gif', async () => imageApi.convertToGif(currentImage.id))` — passes the server-side GIF conversion as the converter function
       - If format is 'original': call `copyImageToClipboard(url, 'original')`
       - On success: `toast.success(t('clipboard.copy_success'), { id: toastId, duration: 2000 })`
       - On failure: `toast.error(result.error || t('clipboard.copy_failed'), { id: toastId })`

    4. Add copy controls to the lightbox overlay area (below the lightbox, above the TagInput):
       - A horizontal bar at `bottom: 100px` (above the TagInput at bottom: 40px) with:
         - A `<select>` dropdown for format: "Copy Original" / "Copy as GIF" options using translation keys
         - A copy button with clipboard icon (SVG) and text from `t('clipboard.copy')`
       - Style the bar with: `backgroundColor: 'var(--color-bg-secondary)'`, `borderRadius: '8px'`, `padding: '8px 16px'`, `display: 'flex'`, `gap: '8px'`, `alignItems: 'center'`, `zIndex: 2000`
       - Style the copy button as primary: `backgroundColor: 'var(--color-accent)'`, `color: 'white'`, `border: 'none'`, `borderRadius: '6px'`, `padding: '8px 16px'`, `cursor: 'pointer'`, `fontWeight: 600`
       - Style the select with: `backgroundColor: 'var(--color-bg-primary)'`, `color: 'var(--color-text-primary)'`, `border: '1px solid var(--color-border)'`, `borderRadius: '6px'`, `padding: '6px 8px'`

    5. Only show copy controls when `currentImage` exists (same condition as TagInput)
  </action>
  <verify>
    - `cd apps/web && bun run build` completes without errors
    - `grep "handleCopy" apps/web/src/components/ImageLightbox.tsx` confirms copy handler exists
    - `grep "copyFormat" apps/web/src/components/ImageLightbox.tsx` confirms format selector state exists
    - `grep "toast" apps/web/src/components/ImageLightbox.tsx` confirms toast feedback integrated
  </verify>
  <done>
    Lightbox displays a copy button with format selector (Original/GIF). Clicking copy fetches the image, converts to PNG (or GIF via server), writes to clipboard, and shows success/failure toast. Format selector lets user choose between original and GIF before copying.
  </done>
</task>

</tasks>

<verification>
1. Open the app, click an image to open lightbox
2. Verify copy controls appear (format dropdown + copy button) above the tag input
3. Select "Copy Original", click copy — toast shows "Copying..." then "Copied successfully"
4. Paste in another app — image appears as PNG
5. Select "Copy as GIF", click copy — toast shows "Copying..." then success
6. Test error case: disconnect network, try copy — toast shows error message
7. In image grid, select images and delete — verify toast.error appears instead of browser alert
8. Test in both light and dark themes — toast and controls should be readable
9. Switch language to English/Chinese — all clipboard text should translate
</verification>

<success_criteria>
- Copy button visible in lightbox with format dropdown
- "Copy Original" copies image as PNG to system clipboard
- "Copy as GIF" converts via server and copies GIF to clipboard
- Toast notifications show for: loading, success, and failure states
- No alert() calls remain in the codebase
- All new UI text available in both Chinese and English
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-operations/08-01-SUMMARY.md`
</output>
