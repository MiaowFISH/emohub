---
phase: 04-search-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/services/imageService.ts
  - packages/server/src/routes/images.ts
  - apps/web/src/lib/api.ts
  - apps/web/src/lib/hooks.ts
  - apps/web/src/stores/imageStore.ts
  - apps/web/src/components/SearchBar.tsx
  - apps/web/src/routes/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can type a keyword and see images filtered by matching tag names"
    - "User can type a keyword and see images filtered by matching filenames"
    - "Search and tag filter work together (AND logic at top level)"
    - "Search results update automatically after user stops typing (debounced)"
    - "Pagination resets to page 1 when search query changes"
  artifacts:
    - path: "packages/server/src/services/imageService.ts"
      provides: "listImages with search parameter"
      contains: "search"
    - path: "packages/server/src/routes/images.ts"
      provides: "search query param parsing"
      contains: "search"
    - path: "apps/web/src/lib/hooks.ts"
      provides: "useDebounce custom hook"
      exports: ["useDebounce"]
    - path: "apps/web/src/components/SearchBar.tsx"
      provides: "Search input component with debouncing"
      exports: ["SearchBar"]
    - path: "apps/web/src/stores/imageStore.ts"
      provides: "searchQuery state and setSearchQuery action"
      contains: "searchQuery"
    - path: "apps/web/src/lib/api.ts"
      provides: "search param in imageApi.list()"
      contains: "search"
  key_links:
    - from: "apps/web/src/components/SearchBar.tsx"
      to: "apps/web/src/stores/imageStore.ts"
      via: "setSearchQuery action"
      pattern: "setSearchQuery"
    - from: "apps/web/src/stores/imageStore.ts"
      to: "apps/web/src/lib/api.ts"
      via: "imageApi.list with search param"
      pattern: "imageApi\\.list.*search"
    - from: "apps/web/src/lib/api.ts"
      to: "packages/server/src/routes/images.ts"
      via: "search query parameter in URL"
      pattern: "search"
    - from: "packages/server/src/routes/images.ts"
      to: "packages/server/src/services/imageService.ts"
      via: "listImages with search argument"
      pattern: "listImages.*search"
---

<objective>
Add text-based search across filenames and tag names, with debounced input and proper integration with existing tag filters.

Purpose: Fulfills SRCH-01 (search by tag names) and SRCH-02 (search by keywords matching filenames or tag names).
Output: Working search bar that filters the image grid in real-time.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-polish/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend search — extend listImages with search parameter</name>
  <files>
    packages/server/src/services/imageService.ts
    packages/server/src/routes/images.ts
  </files>
  <action>
    1. In `imageService.ts`, add a `search?: string` parameter to `listImages()` after `tagIds`.
    2. Build the Prisma `where` clause using AND logic at the top level:
       - If `tagIds` provided: `{ tags: { some: { tagId: { in: tagIds } } } }`
       - If `search` provided (trimmed, non-empty): OR condition matching `{ originalName: { contains: search, mode: 'insensitive' } }` OR `{ tags: { some: { tag: { name: { contains: search, mode: 'insensitive' } } } } }`
       - Combine both with `where.AND = conditions` when multiple conditions exist.
    3. In `images.ts` route GET `/`, extract `search` from query params alongside existing `page`, `limit`, `tagIds`.
    4. Pass `search` (as string or undefined) to `imageService.listImages()`.

    Important: Use Prisma's `mode: 'insensitive'` for case-insensitive matching. Tag filter AND search are top-level AND; search internally uses OR for filename/tag matching.
  </action>
  <verify>
    Build the server: `cd /opt/.openclaw/workspace/external/emohub && bun run --filter server build` (or equivalent). Verify no TypeScript errors.
  </verify>
  <done>
    GET /api/images?search=cat returns images whose originalName contains "cat" OR have a tag named containing "cat". Combined with tagIds, both filters apply as AND.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend search — SearchBar component, useDebounce hook, store and API wiring</name>
  <files>
    apps/web/src/lib/hooks.ts
    apps/web/src/lib/api.ts
    apps/web/src/stores/imageStore.ts
    apps/web/src/components/SearchBar.tsx
    apps/web/src/routes/index.tsx
  </files>
  <action>
    1. Create `apps/web/src/lib/hooks.ts` with a `useDebounce<T>(value: T, delay: number): T` hook using useState + useEffect with setTimeout/clearTimeout pattern. Use 400ms as the recommended delay.

    2. In `apps/web/src/lib/api.ts`, update `imageApi.list()` to accept an optional `search?: string` parameter. Append `search` to URLSearchParams when provided and non-empty.

    3. In `apps/web/src/stores/imageStore.ts`:
       - Add `searchQuery: string` to ImageState interface (default: `''`).
       - Add `setSearchQuery: (query: string) => void` action.
       - `setSearchQuery` should set the query and call `fetchImages(1, activeTagFilter, query)` to reset to page 1.
       - Update `fetchImages` signature to accept optional `search?: string` parameter, pass it to `imageApi.list()`.
       - Update `fetchMore` to pass current `searchQuery` to `imageApi.list()`.
       - Store `searchQuery` in state so `fetchMore` can access it.

    4. Create `apps/web/src/components/SearchBar.tsx`:
       - Local `inputValue` state for immediate input feedback.
       - Use `useDebounce(inputValue, 400)` for debounced value.
       - `useEffect` watching `debouncedSearch` calls `setSearchQuery` from imageStore.
       - Render an `<input type="search">` with placeholder "Search by filename or tag...", `aria-label="Search images"`.
       - Style: full width, padding 8px 12px, border 1px solid #d1d5db, borderRadius 6px, fontSize 14px. Include a clear button (the native search input clear works).

    5. In `apps/web/src/routes/index.tsx`, import and add `<SearchBar />` in the header area, between the upload/manage-tags row and the ImageToolbar. Give it appropriate spacing.

    6. Update `TagFilter.tsx` effect: when re-fetching images on filter change, also pass current `searchQuery` from imageStore so search persists when toggling tags.
  </action>
  <verify>
    Run `cd /opt/.openclaw/workspace/external/emohub && bun run --filter web build` to verify no TypeScript/build errors.
  </verify>
  <done>
    SearchBar appears on the home page. Typing a keyword debounces for 400ms then filters the grid. Tag filter + search work together. Pagination resets on new search. Infinite scroll continues to work with active search.
  </done>
</task>

</tasks>

<verification>
1. Server builds without errors
2. Web app builds without errors
3. Search input visible on home page
4. Typing triggers debounced API call with search param
5. Results filter by filename OR tag name match
6. Tag filter + search combine with AND logic
7. Page resets to 1 on search change
8. Infinite scroll works with active search query
</verification>

<success_criteria>
- SRCH-01: User can search images by typing tag names and see filtered results
- SRCH-02: User can search images by typing keywords that match filenames or tag names
- Both search and tag filter work simultaneously
- No regressions in existing image grid, upload, or tag functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-polish/04-01-SUMMARY.md`
</output>
