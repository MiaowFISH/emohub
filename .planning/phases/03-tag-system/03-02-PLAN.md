---
phase: 03-tag-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/package.json
  - apps/web/src/components/TagInput.tsx
  - apps/web/src/components/TagManager.tsx
  - apps/web/src/components/ImageGrid.tsx
  - apps/web/src/components/ImageLightbox.tsx
autonomous: true

must_haves:
  truths:
    - "User can add tags to a single image via tag input with autocomplete"
    - "User can create new tags inline while tagging an image"
    - "User can remove a tag from an image by clicking the remove button"
    - "User can view a tag management panel to rename and delete tags"
    - "Tag autocomplete shows existing tags filtered by typed text"
  artifacts:
    - path: "apps/web/src/components/TagInput.tsx"
      provides: "Reusable tag input with autocomplete and inline creation"
      min_lines: 40
    - path: "apps/web/src/components/TagManager.tsx"
      provides: "Tag CRUD management panel (rename, delete with usage count)"
      min_lines: 50
  key_links:
    - from: "apps/web/src/components/TagInput.tsx"
      to: "apps/web/src/stores/tagStore.ts"
      via: "useTagStore for suggestions"
      pattern: "useTagStore"
    - from: "apps/web/src/components/TagInput.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "tagApi for add/remove operations"
      pattern: "tagApi\\."
    - from: "apps/web/src/components/TagManager.tsx"
      to: "apps/web/src/stores/tagStore.ts"
      via: "useTagStore for CRUD operations"
      pattern: "useTagStore"
---

<objective>
Build the tag input component for single-image tagging (TAG-01) and the tag management UI for creating, renaming, and deleting tags (TAG-02).

Purpose: These are the core tagging interactions — users need to tag individual images and manage their tag vocabulary. The TagInput component is also reused by batch tagging in Plan 04.

Output: TagInput component with autocomplete + inline creation, TagManager panel for tag CRUD, tags visible on images in the grid and lightbox.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tag-system/03-RESEARCH.md
@.planning/phases/03-tag-system/03-01-SUMMARY.md
@packages/shared/src/tag.ts
@apps/web/src/lib/api.ts
@apps/web/src/stores/tagStore.ts
@apps/web/src/stores/imageStore.ts
@apps/web/src/components/ImageGrid.tsx
@apps/web/src/components/ImageLightbox.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TagInput component with autocomplete and inline tag creation</name>
  <files>
    apps/web/package.json
    apps/web/src/components/TagInput.tsx
  </files>
  <action>
1. Install react-tag-autocomplete: `cd apps/web && bun add react-tag-autocomplete`

2. Create `apps/web/src/components/TagInput.tsx`:
   - Props: `imageId: string`, `currentTags: Array<{ id: string; name: string; category: string | null }>`, `onTagsChange: (tags: Array<{ id: string; name: string; category: string | null }>) => void`
   - Use `react-tag-autocomplete` `ReactTags` component:
     - `selected`: Map currentTags to `{ value: tag.id, label: tag.name }` format
     - `suggestions`: From `useTagStore().tags`, mapped to `{ value: tag.id, label: tag.name }`, filtered to exclude already-selected tags
     - `onAdd`: When a tag is added:
       - If it's an existing tag (has value/id), call `tagApi.batchAdd([imageId], [tag.value])` then update onTagsChange
       - If it's a new tag (user typed a new name), call `tagApi.create(tag.label)` first to get the tag id, then call `tagApi.batchAdd([imageId], [newTag.id])`, then update onTagsChange and refresh tagStore
     - `onDelete`: When tag removed at index, call `tagApi.batchRemove([imageId], [removedTag.id])`, update onTagsChange
     - `allowNew: true` — enables creating new tags by typing
     - `placeholderText: "Add tags..."`
     - `noOptionsText: "No matching tags"`
   - Fetch tags on mount: call `useTagStore().fetchTags()` if tags list is empty
   - Style the component to fit inline (compact height, subtle border). Use the library's default CSS or provide minimal custom styles via `classNames` prop.
   - Import the library's CSS: `import 'react-tag-autocomplete/example/css/react-tags.css'` or provide equivalent inline styles if CSS import is problematic. If the CSS file path doesn't exist, create minimal styles inline using the `classNames` prop with inline style overrides.
   - Handle errors: wrap API calls in try/catch, show console.error on failure (don't break UI).
  </action>
  <verify>
Run `cd /opt/.openclaw/workspace/external/emohub/apps/web && npx tsc --noEmit` to verify TypeScript compiles. Verify react-tag-autocomplete is in package.json dependencies.
  </verify>
  <done>TagInput component renders with autocomplete suggestions from tag store. Adding an existing tag calls batchAdd API. Typing a new tag name creates it via create API then associates it. Removing a tag calls batchRemove API. All operations update parent via onTagsChange callback.</done>
</task>

<task type="auto">
  <name>Task 2: TagManager panel and tag display on images</name>
  <files>
    apps/web/src/components/TagManager.tsx
    apps/web/src/components/ImageGrid.tsx
    apps/web/src/components/ImageLightbox.tsx
  </files>
  <action>
1. Create `apps/web/src/components/TagManager.tsx`:
   - A modal/panel component toggled from the home page (button in header area)
   - Shows all tags from `useTagStore().tags` in a scrollable list
   - Each tag row shows: tag name, image count (from TagWithCount.imageCount), rename button, delete button
   - Rename: Click rename → inline text input replaces name → Enter to confirm → calls `useTagStore().renameTag(id, newName)` → reverts to display mode
   - Delete: Click delete → if imageCount > 0, show warning "This tag is used on {N} images. Remove it?" → confirm calls `useTagStore().deleteTag(id)`
   - If imageCount === 0, delete without confirmation
   - Add a "Create Tag" row at top: text input + "Add" button → calls `useTagStore().createTag(name)`
   - Style: modal overlay (reuse pattern from ImageToolbar's confirm dialog), max-height 70vh with overflow scroll, clean list layout
   - Close button in header

2. Modify `apps/web/src/components/ImageGrid.tsx`:
   - The image list API now returns tags with each image (from Plan 01 changes)
   - Display tags below each thumbnail: small pill/badge elements showing tag names
   - Limit visible tags to 3, show "+N more" if more exist
   - Style pills: small rounded background (#e5e7eb), font-size 11px, padding 2px 6px
   - Tags should not interfere with selection checkbox or lightbox click

3. Modify `apps/web/src/components/ImageLightbox.tsx`:
   - Add TagInput component below the full-size image in the lightbox
   - Pass the current image's tags and imageId to TagInput
   - When tags change via TagInput's onTagsChange, update the image in imageStore (add a method or update locally)
   - This is the primary way users tag individual images: open lightbox → see/edit tags
   - Position TagInput at the bottom of the lightbox content area, styled to not obstruct the image
  </action>
  <verify>
Run `cd /opt/.openclaw/workspace/external/emohub/apps/web && npx tsc --noEmit` to verify TypeScript compiles. Start the dev server and verify:
1. Image grid shows tag pills on images that have tags
2. Opening lightbox shows TagInput below the image
3. TagManager modal opens and shows tag list with counts
4. Can rename and delete tags from TagManager
  </verify>
  <done>Tag pills display on image thumbnails in the grid (max 3 visible). Lightbox shows TagInput for editing tags on the current image. TagManager modal provides full tag CRUD with usage counts, rename, and delete with confirmation for in-use tags.</done>
</task>

</tasks>

<verification>
1. TagInput renders with autocomplete dropdown showing existing tags
2. Typing a new tag name and pressing Enter creates the tag and associates it
3. Clicking X on a tag removes it from the image
4. Image grid shows tag pills on thumbnails
5. Lightbox shows editable tags via TagInput
6. TagManager lists all tags with image counts
7. Renaming a tag updates it everywhere
8. Deleting a tag with confirmation removes it and its associations
9. No TypeScript compilation errors
</verification>

<success_criteria>
- User can add multiple tags to a single image via lightbox TagInput (TAG-01)
- User can create new tags inline or via TagManager (TAG-02)
- User can rename and delete tags via TagManager (TAG-02)
- Tags are visible on image thumbnails in the grid
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-tag-system/03-02-SUMMARY.md`
</output>
