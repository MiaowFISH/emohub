---
phase: 03-tag-system
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - apps/web/src/components/ImageToolbar.tsx
  - apps/web/src/components/BatchTagModal.tsx
autonomous: false

must_haves:
  truths:
    - "User can select multiple images and add tags to all of them at once"
    - "User can select multiple images and remove tags from all of them at once"
    - "Batch tagging modal shows tag input with autocomplete"
    - "After batch operation, image grid updates to reflect new tags"
  artifacts:
    - path: "apps/web/src/components/BatchTagModal.tsx"
      provides: "Modal for batch add/remove tags on selected images"
      min_lines: 50
  key_links:
    - from: "apps/web/src/components/ImageToolbar.tsx"
      to: "apps/web/src/components/BatchTagModal.tsx"
      via: "opens modal on button click"
      pattern: "BatchTagModal"
    - from: "apps/web/src/components/BatchTagModal.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "tagApi.batchAdd and tagApi.batchRemove"
      pattern: "tagApi\\.batch"
---

<objective>
Add batch tagging operations to the ImageToolbar (TAG-04) and verify all tag system requirements with human testing.

Purpose: Batch tagging is critical for organizing 4000+ stickers efficiently. Users select images, then add or remove tags in bulk. This completes the tag system feature set.

Output: BatchTagModal component, "Add Tags" and "Remove Tags" buttons in ImageToolbar, human verification of all TAG requirements.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tag-system/03-01-SUMMARY.md
@.planning/phases/03-tag-system/03-02-SUMMARY.md
@.planning/phases/03-tag-system/03-03-SUMMARY.md
@apps/web/src/components/ImageToolbar.tsx
@apps/web/src/components/TagInput.tsx
@apps/web/src/stores/tagStore.ts
@apps/web/src/stores/imageStore.ts
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: BatchTagModal and ImageToolbar integration</name>
  <files>
    apps/web/src/components/BatchTagModal.tsx
    apps/web/src/components/ImageToolbar.tsx
  </files>
  <action>
1. Create `apps/web/src/components/BatchTagModal.tsx`:
   - Props: `mode: 'add' | 'remove'`, `imageIds: string[]`, `onClose: () => void`, `onComplete: () => void`
   - Modal overlay (reuse pattern from ImageToolbar's confirm dialog: fixed position, backdrop, centered white card)
   - Header: "Add Tags to {N} Images" or "Remove Tags from {N} Images" based on mode
   - For "add" mode:
     - Reuse TagInput concept but without an imageId — instead, maintain a local `selectedTags` state array
     - Use react-tag-autocomplete ReactTags with suggestions from useTagStore().tags
     - Allow creating new tags inline (allowNew: true) — on add, if new tag, create via tagApi.create first
     - "Apply" button: calls `tagApi.batchAdd(imageIds, selectedTags.map(t => t.id))`, then onComplete
   - For "remove" mode:
     - Show tags that are common across ALL selected images (intersection), or show all tags from any selected image (union) with counts
     - Simpler approach: show checkboxes for tags to remove. Fetch tags for selected images by querying each image's tags (or use a combined query). For simplicity, show all tags from tagStore and let user pick which to remove.
     - Use checkboxes instead of ReactTags for remove mode — user checks tags to remove
     - "Remove" button: calls `tagApi.batchRemove(imageIds, checkedTagIds)`, then onComplete
   - Loading state on Apply/Remove button while API call is in progress
   - Error handling: try/catch with alert on failure
   - onComplete should: refresh tagStore (counts changed), refresh imageStore (tags on images changed), close modal

2. Modify `apps/web/src/components/ImageToolbar.tsx`:
   - Add two new buttons between the divider and Delete button:
     - "Add Tags" button (green #10b981 background, white text) — opens BatchTagModal in 'add' mode
     - "Remove Tags" button (orange #f59e0b background, white text) — opens BatchTagModal in 'remove' mode
   - Add state: `const [batchTagMode, setBatchTagMode] = useState<'add' | 'remove' | null>(null)`
   - Render BatchTagModal when batchTagMode is not null:
     ```
     {batchTagMode && (
       <BatchTagModal
         mode={batchTagMode}
         imageIds={Array.from(selectedIds)}
         onClose={() => setBatchTagMode(null)}
         onComplete={() => { setBatchTagMode(null); /* refresh stores */ }}
       />
     )}
     ```
   - onComplete handler: call `useTagStore().fetchTags()` to refresh counts, call `useImageStore().fetchImages()` to refresh image tags in grid
   - Import BatchTagModal, useTagStore
  </action>
  <verify>
Run `cd /opt/.openclaw/workspace/external/emohub/apps/web && npx tsc --noEmit` to verify TypeScript compiles. Start dev server and verify:
1. Select multiple images → toolbar shows "Add Tags" and "Remove Tags" buttons
2. Click "Add Tags" → modal opens with tag input
3. Add tags and click Apply → tags are added to all selected images
4. Click "Remove Tags" → modal shows tag checkboxes
5. Check tags and click Remove → tags are removed from selected images
6. Grid updates after batch operations
  </verify>
  <done>BatchTagModal supports both add and remove modes. ImageToolbar has "Add Tags" and "Remove Tags" buttons. Batch add creates new tags inline and associates them. Batch remove shows checkboxes for tag selection. Both modes refresh stores on completion.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of all TAG requirements</name>
  <files>apps/web/src/components</files>
  <action>
Human verifies the complete tag system. What was built:
Complete tag system: single-image tagging with autocomplete (TAG-01), tag management with create/rename/delete (TAG-02), tag filtering sidebar (TAG-03), and batch tag operations (TAG-04).
  </action>
  <verify>
Start the dev server: `cd /opt/.openclaw/workspace/external/emohub && bun run dev`

**TAG-01: Add multiple tags to a single image**
1. Click an image to open lightbox
2. In the tag input below the image, type a tag name
3. Verify autocomplete suggestions appear
4. Select or create a tag — verify it appears as a pill on the image
5. Add 2-3 more tags to the same image
6. Close and reopen lightbox — verify tags persist

**TAG-02: Create, rename, delete tags**
1. Click "Manage Tags" button
2. Create a new tag using the input at the top
3. Verify it appears in the list with count 0
4. Click rename on a tag — change its name — verify it updates
5. Delete a tag with 0 images — verify no confirmation needed
6. Delete a tag with images — verify confirmation warning shows count
7. Confirm delete — verify tag is removed

**TAG-03: Filter images by tags**
1. Look at the left sidebar — verify tags are listed with image counts
2. Click a tag checkbox — verify grid filters to show only images with that tag
3. Click a second tag — verify grid narrows further (AND logic)
4. Click "Clear" — verify all images return
5. Scroll down with filter active — verify infinite scroll loads more filtered results

**TAG-04: Batch add/remove tags**
1. Select 3+ images using checkboxes
2. Click "Add Tags" in toolbar
3. Add 2 tags in the modal and click Apply
4. Verify all selected images now show those tags
5. Select the same images again
6. Click "Remove Tags" in toolbar
7. Check one tag and click Remove
8. Verify that tag is removed from all selected images
  </verify>
  <done>All TAG-01 through TAG-04 requirements pass human verification. Type "approved" or describe issues found.</done>
</task>

</tasks>

<verification>
1. Batch add tags works for multiple images simultaneously
2. Batch remove tags works for multiple images simultaneously
3. New tags can be created inline during batch add
4. Stores refresh after batch operations (tag counts, image tags)
5. All four TAG requirements verified by human testing
</verification>

<success_criteria>
- User can batch add tags to selected images (TAG-04)
- User can batch remove tags from selected images (TAG-04)
- All TAG-01 through TAG-04 requirements pass human verification
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-tag-system/03-04-SUMMARY.md`
</output>
