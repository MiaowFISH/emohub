---
phase: 03-tag-system
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/src/components/TagFilter.tsx
  - apps/web/src/routes/index.tsx
  - apps/web/src/stores/imageStore.ts
autonomous: true

must_haves:
  truths:
    - "User can see a sidebar with all tags and their image counts"
    - "User can click tags to filter the image grid to matching images only"
    - "User can select multiple tags to narrow results (AND filtering)"
    - "User can clear all filters to return to the full image list"
    - "Filtered image count updates in real-time as filters change"
  artifacts:
    - path: "apps/web/src/components/TagFilter.tsx"
      provides: "Tag filter sidebar with checkboxes and counts"
      min_lines: 40
  key_links:
    - from: "apps/web/src/components/TagFilter.tsx"
      to: "apps/web/src/stores/tagStore.ts"
      via: "useTagStore for tag list and filter state"
      pattern: "useTagStore"
    - from: "apps/web/src/components/TagFilter.tsx"
      to: "apps/web/src/stores/imageStore.ts"
      via: "triggers fetchImages with tagIds when filters change"
      pattern: "fetchImages"
    - from: "apps/web/src/routes/index.tsx"
      to: "apps/web/src/components/TagFilter.tsx"
      via: "sidebar layout integration"
      pattern: "TagFilter"
---

<objective>
Build the tag filtering sidebar that lets users filter the image grid by selecting tags (TAG-03).

Purpose: With 4000+ stickers, filtering by tags is essential for finding specific images. The sidebar provides always-visible tag navigation alongside the image grid.

Output: TagFilter sidebar component integrated into the home page layout, connected to image store for server-side filtered queries.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tag-system/03-RESEARCH.md
@.planning/phases/03-tag-system/03-01-SUMMARY.md
@apps/web/src/routes/index.tsx
@apps/web/src/stores/tagStore.ts
@apps/web/src/stores/imageStore.ts
@apps/web/src/components/ImageGrid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TagFilter sidebar component</name>
  <files>
    apps/web/src/components/TagFilter.tsx
  </files>
  <action>
1. Create `apps/web/src/components/TagFilter.tsx`:
   - Uses `useTagStore()` to get `tags`, `filterTagIds`, `toggleFilterTag`, `clearFilters`, `fetchTags`
   - Fetches tags on mount if not already loaded: `useEffect(() => { fetchTags() }, [])`
   - Layout: vertical sidebar, 240px wide, border-right, padding 16px
   - Header row: "Filter by Tags" title (14px, font-weight 600) + "Clear" button (only visible when filterTagIds.size > 0, blue text, 12px)
   - Tag list: scrollable container (max-height calc(100vh - 200px), overflow-y auto)
   - Each tag rendered as a label with:
     - Checkbox input: `checked={filterTagIds.has(tag.id)}`, `onChange={() => toggleFilterTag(tag.id)}`
     - Tag name (14px)
     - Image count badge on the right (12px, gray #9ca3af, margin-left auto)
   - Tags sorted alphabetically by name
   - When no tags exist, show "No tags yet" message in gray
   - When filters are active, show a summary line above the list: "Showing images with {N} tag(s)"

2. Wire filtering to image fetching:
   - Use a `useEffect` that watches `filterTagIds` changes
   - When filterTagIds changes, call `useImageStore().fetchImages(1, Array.from(filterTagIds))` to re-fetch page 1 with the selected tag filter
   - This triggers server-side filtering (implemented in Plan 01)
   - When filterTagIds becomes empty, call `fetchImages(1)` without tagIds to show all images
   - Debounce is not needed since these are checkbox clicks (discrete events), not typing
  </action>
  <verify>
Run `cd /opt/.openclaw/workspace/external/emohub/apps/web && npx tsc --noEmit` to verify TypeScript compiles. Component should render without errors.
  </verify>
  <done>TagFilter component renders a sidebar with all tags as checkboxes with image counts. Clicking a tag checkbox triggers server-side filtered image fetch. Clear button resets all filters. Scrollable for many tags.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate TagFilter sidebar into home page layout</name>
  <files>
    apps/web/src/routes/index.tsx
    apps/web/src/stores/imageStore.ts
  </files>
  <action>
1. Modify `apps/web/src/routes/index.tsx`:
   - Import `TagFilter` from `@/components/TagFilter`
   - Import `TagManager` from `@/components/TagManager` (created in Plan 02, but add import + button even if component doesn't exist yet — it will be created in parallel Plan 02)
   - Restructure layout to a two-column design:
     - Outer container: `display: flex`, `height: 100vh`
     - Left sidebar: `<TagFilter />` — fixed width 240px, full height
     - Right main area: `flex: 1`, contains the existing content (ImageUpload, ImageToolbar, ImageGrid, ImageLightbox) with padding and vertical flex layout
   - Add a "Manage Tags" button in the header area (near ImageUpload) that opens TagManager modal
   - Add state: `const [showTagManager, setShowTagManager] = useState(false)`
   - Render `{showTagManager && <TagManager onClose={() => setShowTagManager(false)} />}` — if TagManager doesn't exist yet from Plan 02, create a minimal placeholder that Plan 02 will replace

2. Update `apps/web/src/stores/imageStore.ts`:
   - Ensure `fetchImages` properly passes `tagIds` to the API
   - Update `fetchMore` to also pass the current tagIds filter (read from tagStore or accept as parameter)
   - The `fetchMore` function needs to know the active filter to load the next page of filtered results. Import `useTagStore` and read `filterTagIds` inside `fetchMore`, or store the current filter in imageStore state.
   - Simplest approach: add `activeTagFilter: string[]` to imageStore state, set it in `fetchImages`, use it in `fetchMore`. This avoids cross-store dependency issues.
  </action>
  <verify>
Run `cd /opt/.openclaw/workspace/external/emohub/apps/web && npx tsc --noEmit` to verify TypeScript compiles. Start dev server and verify:
1. Home page shows sidebar on the left, image grid on the right
2. Clicking tag checkboxes filters the image grid
3. Clearing filters shows all images
4. Infinite scroll works with active filters (loads more filtered results)
5. "Manage Tags" button is visible
  </verify>
  <done>Home page has two-column layout with TagFilter sidebar on left and main content on right. Tag filtering triggers server-side queries and updates the grid. Infinite scroll respects active tag filters. Manage Tags button opens tag management UI.</done>
</task>

</tasks>

<verification>
1. TagFilter sidebar renders with all tags and image counts
2. Clicking a tag checkbox filters the image grid (server-side)
3. Selecting multiple tags narrows results (AND logic)
4. Clear button removes all filters and shows all images
5. Infinite scroll loads more filtered results correctly
6. Two-column layout works (sidebar + main content)
7. No TypeScript compilation errors
</verification>

<success_criteria>
- User can filter the image grid by clicking tag checkboxes in the sidebar (TAG-03)
- Multiple tag selection narrows results with AND logic
- Filter state persists during scrolling (infinite scroll loads filtered pages)
- Clear filters returns to full image list
- Layout is clean two-column design
</success_criteria>

<output>
After completion, create `.planning/phases/03-tag-system/03-03-SUMMARY.md`
</output>
