---
phase: 02-image-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/services/imageProcessor.ts
  - packages/server/src/services/imageService.ts
  - packages/server/src/routes/images.ts
  - packages/server/src/app.ts
  - packages/server/package.json
autonomous: true

must_haves:
  truths:
    - "POST /api/images/upload accepts multipart files, streams to disk, compresses, generates thumbnails, detects duplicates via SHA-256, and returns image records"
    - "GET /api/images returns paginated list of images"
    - "GET /api/images/:id/thumbnail and /api/images/:id/full serve image files from disk"
    - "DELETE /api/images/:id removes image record and files from disk"
    - "POST /api/images/:id/convert-gif converts image to single-frame GIF and returns download"
  artifacts:
    - path: "packages/server/src/services/imageProcessor.ts"
      provides: "Sharp-based image compression, thumbnail generation, GIF conversion"
      exports: ["compressImage", "generateThumbnail", "convertToGif", "getImageMetadata"]
    - path: "packages/server/src/services/imageService.ts"
      provides: "Business logic for image CRUD, hash-based duplicate detection"
      exports: ["uploadImage", "listImages", "getImage", "deleteImage", "convertImageToGif"]
    - path: "packages/server/src/routes/images.ts"
      provides: "Fastify route handlers for all image endpoints"
      exports: ["default (FastifyPluginAsync)"]
  key_links:
    - from: "packages/server/src/routes/images.ts"
      to: "packages/server/src/services/imageService.ts"
      via: "import and call service functions"
      pattern: "import.*imageService"
    - from: "packages/server/src/services/imageService.ts"
      to: "packages/server/src/services/imageProcessor.ts"
      via: "import and call processor functions"
      pattern: "import.*imageProcessor"
    - from: "packages/server/src/services/imageService.ts"
      to: "prisma.image"
      via: "Prisma client for database operations"
      pattern: "prisma\\.image\\.(findMany|findUnique|create|delete)"
    - from: "packages/server/src/app.ts"
      to: "packages/server/src/routes/images.ts"
      via: "Fastify plugin registration"
      pattern: "register.*imageRoutes"
---

<objective>
Build the complete server-side image management backend: processing pipeline (sharp), business logic service, and all API routes.

Purpose: Provides the API foundation that all frontend image features depend on — upload, list, serve, delete, and GIF conversion.
Output: Working API endpoints at /api/images/* that handle the full image lifecycle.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-image-management/02-RESEARCH.md
@packages/server/src/app.ts
@packages/server/src/plugins/db.ts
@packages/server/src/plugins/storage.ts
@packages/server/src/utils/storage.ts
@packages/shared/src/image.ts
@packages/shared/src/api.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Image processor service and image business logic service</name>
  <files>
    packages/server/src/services/imageProcessor.ts
    packages/server/src/services/imageService.ts
    packages/server/package.json
  </files>
  <action>
Install server dependencies: `cd /opt/.openclaw/workspace/external/emohub/packages/server && bun add @fastify/multipart sharp && bun add -d @types/better-sqlite3`

Create `packages/server/src/services/imageProcessor.ts`:
- `getImageMetadata(inputPath: string)` — uses sharp to read width, height, format, size. Returns `{ width, height, format, size }`.
- `compressImage(inputPath: string, outputPath: string)` — sharp resize max 2048x2048 (fit: inside, withoutEnlargement: true), output as original format with quality 85 for JPEG (mozjpeg: true), quality 85 for WebP, compression level 9 for PNG. Create parent directory with `mkdir -p` before writing. Returns metadata of compressed image.
- `generateThumbnail(inputPath: string, outputPath: string)` — sharp resize 300x300 (fit: cover), output as JPEG quality 80. Create parent directory before writing.
- `convertToGif(inputPath: string, outputPath: string)` — sharp convert to GIF format, resize max 300x300 (fit: inside, withoutEnlargement: true). Returns output path.
- All functions use async/await, never buffer entire images in memory.

Create `packages/server/src/services/imageService.ts`:
- Import PrismaClient type, imageProcessor functions, storage utils (getImagePath, getThumbnailPath), crypto, fs, stream, path, os.
- `hashFile(filePath: string): Promise<string>` — read file from disk, compute SHA-256 hex digest using crypto.createHash.
- `uploadImage(prisma, file: { filename, mimetype, file (readable stream) })` — (1) stream file to temp path in os.tmpdir(), (2) compute SHA-256 hash of temp file, (3) check prisma.image.findUnique({ where: { hash } }) for duplicate — if found, delete temp file and return `{ duplicate: true, image: existing }`, (4) get metadata via imageProcessor.getImageMetadata, (5) compress to final path via getImagePath(hash), (6) generate thumbnail to getThumbnailPath(hash), (7) create prisma.image record with all fields, (8) delete temp file, (9) return `{ duplicate: false, image }`. Wrap in try-catch; on error delete temp file and any partial outputs.
- `listImages(prisma, page: number, limit: number)` — prisma.image.findMany with skip/take, orderBy createdAt desc. Also get total count. Return `{ images, total, page, limit }`.
- `getImage(prisma, id: string)` — prisma.image.findUnique by id. Return image or null.
- `deleteImage(prisma, id: string)` — find image, delete files from disk (storagePath, thumbnailPath), delete prisma record. Return deleted image. Handle file-not-found gracefully (log warning, continue).
- `convertImageToGif(prisma, id: string)` — find image, call imageProcessor.convertToGif with source as the compressed image path, output to a temp file. Return the temp file path (caller handles response streaming and cleanup).
  </action>
  <verify>
`cd /opt/.openclaw/workspace/external/emohub && bun run --filter @emohub/server -- tsc --noEmit` passes (or equivalent type check). Files exist and export expected functions.
  </verify>
  <done>imageProcessor.ts exports compressImage, generateThumbnail, convertToGif, getImageMetadata. imageService.ts exports uploadImage, listImages, getImage, deleteImage, convertImageToGif. Both compile without type errors.</done>
</task>

<task type="auto">
  <name>Task 2: Image API routes and app registration</name>
  <files>
    packages/server/src/routes/images.ts
    packages/server/src/app.ts
  </files>
  <action>
Create `packages/server/src/routes/images.ts` as a FastifyPluginAsync:

Register @fastify/multipart on the plugin instance with limits: `{ fileSize: 10 * 1024 * 1024 }` (10MB max).

Routes:

1. `POST /upload` — call `req.file()` to get multipart file data, pass to imageService.uploadImage(fastify.prisma, file). Return ApiResponse with image data and `duplicate` boolean flag. If duplicate, return 200 with `{ success: true, data: image, duplicate: true }`. On success return 201. On error return 400 with error message. Accept multiple files: use `req.files()` iterator, process each sequentially, collect results array.

2. `GET /` — parse query params `page` (default 1) and `limit` (default 50). Call imageService.listImages. Return PaginatedResponse.

3. `GET /:id/thumbnail` — call imageService.getImage, if not found return 404. Read thumbnailPath from image record, stream file with `reply.type('image/jpeg').send(fs.createReadStream(thumbnailPath))`. If thumbnailPath is null or file doesn't exist, fall back to serving the compressed image.

4. `GET /:id/full` — same pattern but serve storagePath (compressed image). Set Content-Type from image.mimeType.

5. `DELETE /:id` — call imageService.deleteImage. Return 200 with deleted image data. If not found return 404.

6. `DELETE /batch` — accept body `{ ids: string[] }`. Delete each via imageService.deleteImage, collect results. Return 200 with results array.

7. `POST /:id/convert-gif` — call imageService.convertImageToGif. Stream the resulting GIF file as response with Content-Type image/gif and Content-Disposition attachment. Clean up temp file after streaming (use reply.raw.on('finish', cleanup) or onSend hook).

Update `packages/server/src/app.ts`:
- Import imageRoutes from './routes/images.js'
- Register with prefix '/api/images': `await app.register(imageRoutes, { prefix: '/api/images' })`
  </action>
  <verify>
`cd /opt/.openclaw/workspace/external/emohub && bun run --filter @emohub/server -- tsc --noEmit` passes. Start server briefly and test: `curl http://localhost:3000/api/images` returns `{"success":true,"data":[],"meta":{"total":0,"page":1,"limit":50}}`.
  </verify>
  <done>All 7 route handlers registered under /api/images. Server starts without errors. GET /api/images returns empty paginated response. Upload, delete, serve, and convert endpoints are wired to service layer.</done>
</task>

</tasks>

<verification>
- Server compiles and starts without errors
- `GET /api/images` returns paginated empty response
- `POST /api/images/upload` with a test image file returns 201 with image data
- `GET /api/images/:id/thumbnail` serves thumbnail JPEG
- `GET /api/images/:id/full` serves compressed image
- `DELETE /api/images/:id` removes image and files
- `POST /api/images/:id/convert-gif` returns GIF file download
- Duplicate upload returns 200 with duplicate flag
</verification>

<success_criteria>
Complete image management API: upload with compression/thumbnail/dedup, list with pagination, serve thumbnails and full images, delete with file cleanup, GIF conversion. All endpoints respond correctly and handle errors gracefully.
</success_criteria>

<output>
After completion, create `.planning/phases/02-image-management/02-01-SUMMARY.md`
</output>
