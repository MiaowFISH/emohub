---
phase: 02-image-management
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - apps/web/src/components/ImageGrid.tsx
  - apps/web/src/components/ImageToolbar.tsx
  - apps/web/src/routes/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can select/deselect individual images by clicking a checkbox overlay on thumbnails"
    - "User can select all or clear selection via toolbar"
    - "User can delete selected images via toolbar button with confirmation"
    - "User can convert a single selected image to GIF and download it"
  artifacts:
    - path: "apps/web/src/components/ImageToolbar.tsx"
      provides: "Selection toolbar with select all, delete, and GIF convert actions"
      exports: ["ImageToolbar"]
  key_links:
    - from: "apps/web/src/components/ImageToolbar.tsx"
      to: "apps/web/src/stores/imageStore.ts"
      via: "reads selectedIds, calls clearSelection, removeImages"
      pattern: "useImageStore"
    - from: "apps/web/src/components/ImageToolbar.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "calls imageApi.deleteBatch and imageApi.convertToGif"
      pattern: "imageApi\\.(deleteBatch|convertToGif)"
---

<objective>
Add image selection, batch delete, and GIF conversion UI to complete the image management feature set.

Purpose: Delivers the remaining management capabilities — multi-select, batch operations, and sticker GIF export for QQ/WeChat.
Output: Toolbar with selection controls, batch delete with confirmation, and one-click GIF conversion download.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-image-management/02-03-SUMMARY.md
@apps/web/src/components/ImageGrid.tsx
@apps/web/src/stores/imageStore.ts
@apps/web/src/lib/api.ts
@apps/web/src/routes/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ImageToolbar and selection mode in ImageGrid</name>
  <files>
    apps/web/src/components/ImageToolbar.tsx
    apps/web/src/components/ImageGrid.tsx
  </files>
  <action>
Create `apps/web/src/components/ImageToolbar.tsx`:
- Import { useImageStore } from '@/stores/imageStore'
- Import { imageApi } from '@/lib/api'
- Import { useState, useCallback } from 'react'

Component `ImageToolbar`:
- Read images, selectedIds, selectAll, clearSelection, removeImages from useImageStore
- State: isDeleting (boolean), isConverting (boolean), showConfirm (boolean)
- Render toolbar bar (flexbox row, gap 8px, padding 8px, background #f9fafb, border-bottom, align-items center):
  - Left side: selection count text: "{selectedIds.size} selected"
  - "Select All" button — calls selectAll()
  - "Clear" button — calls clearSelection(), only visible when selectedIds.size > 0
  - Separator (vertical line)
  - "Delete" button (red) — disabled if selectedIds.size === 0. onClick: set showConfirm true.
  - "Convert to GIF" button — disabled if selectedIds.size !== 1 (only single image conversion). onClick: call imageApi.convertToGif with the single selected id, create a Blob URL, trigger download via creating a temporary <a> element with download attribute, revoke Blob URL after. Set isConverting during operation.
- Confirmation dialog (simple inline or overlay):
  - When showConfirm is true, show: "Delete {selectedIds.size} image(s)? This cannot be undone."
  - "Cancel" button: set showConfirm false
  - "Delete" button (red): set isDeleting true, call imageApi.deleteBatch([...selectedIds]), on success call removeImages([...selectedIds]) and clearSelection(), set isDeleting false, set showConfirm false. On error, show alert with error message.
- Toolbar only visible when selectedIds.size > 0 (or always visible but actions disabled — use your judgment for better UX).

Update `apps/web/src/components/ImageGrid.tsx`:
- Add a selection checkbox overlay on each thumbnail: positioned absolute top-left, small checkbox or circle indicator.
- Clicking the checkbox calls toggleSelect(image.id) and stops event propagation (so it doesn't trigger lightbox).
- Clicking the image itself still opens lightbox (existing behavior).
- When image is selected (selectedIds.has(image.id)): show blue border (3px solid #3b82f6) and checkbox filled/checked state.
- When not selected: checkbox is semi-transparent, appears on hover.
  </action>
  <verify>
`cd /opt/.openclaw/workspace/external/emohub/apps/web && bunx vite build` passes. ImageToolbar.tsx exists. ImageGrid.tsx has selection checkboxes.
  </verify>
  <done>ImageToolbar shows selection count, select all/clear, delete with confirmation, and GIF convert. ImageGrid thumbnails have selection checkboxes with visual feedback.</done>
</task>

<task type="auto">
  <name>Task 2: Wire toolbar into home page layout</name>
  <files>
    apps/web/src/routes/index.tsx
  </files>
  <action>
Update `apps/web/src/routes/index.tsx`:
- Import ImageToolbar from '@/components/ImageToolbar'
- Add ImageToolbar between ImageUpload and ImageGrid in the layout
- Layout order: ImageUpload (top) → ImageToolbar (sticky, only when selection active) → ImageGrid (flex: 1) → ImageLightbox (overlay)
- ImageToolbar should be sticky (position: sticky, top: 0, z-index: 10) so it stays visible while scrolling the grid
  </action>
  <verify>
`cd /opt/.openclaw/workspace/external/emohub/apps/web && bunx vite build` passes. Home page renders toolbar between upload and grid.
  </verify>
  <done>Toolbar is wired into home page, sticky positioned above grid. Full selection → delete/convert flow is connected end-to-end.</done>
</task>

</tasks>

<verification>
- Clicking checkbox on thumbnail selects/deselects image
- Toolbar shows correct selection count
- "Select All" selects all images, "Clear" deselects all
- "Delete" shows confirmation, then removes images from grid and server
- "Convert to GIF" downloads a GIF file for single selected image
- Selection checkboxes don't interfere with lightbox click
</verification>

<success_criteria>
Users can select images, batch delete with confirmation, and convert individual images to GIF for download. All management operations (IMG-02, IMG-08) are functional.
</success_criteria>

<output>
After completion, create `.planning/phases/02-image-management/02-04-SUMMARY.md`
</output>
