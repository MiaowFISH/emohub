---
phase: 02-image-management
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/web/package.json
  - apps/web/src/components/ImageUpload.tsx
  - apps/web/src/components/ImageGrid.tsx
  - apps/web/src/components/ImageLightbox.tsx
  - apps/web/src/routes/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag and drop or click to select multiple images for upload"
    - "Upload shows progress feedback and reports duplicates"
    - "User can view all uploaded images in a virtual-scrolled grid of thumbnails"
    - "User can click any thumbnail to open full-size lightbox preview with keyboard navigation"
  artifacts:
    - path: "apps/web/src/components/ImageUpload.tsx"
      provides: "Drag-drop upload zone with file validation and upload progress"
      exports: ["ImageUpload"]
    - path: "apps/web/src/components/ImageGrid.tsx"
      provides: "Virtual scrolling grid rendering thumbnails with dynamic columns"
      exports: ["ImageGrid"]
    - path: "apps/web/src/components/ImageLightbox.tsx"
      provides: "Full-size image preview with keyboard navigation"
      exports: ["ImageLightbox"]
  key_links:
    - from: "apps/web/src/components/ImageUpload.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "calls imageApi.upload"
      pattern: "imageApi\\.upload"
    - from: "apps/web/src/components/ImageUpload.tsx"
      to: "apps/web/src/stores/imageStore.ts"
      via: "calls addImages after upload"
      pattern: "useImageStore.*addImages"
    - from: "apps/web/src/components/ImageGrid.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "uses imageApi.getThumbnailUrl for src"
      pattern: "imageApi\\.getThumbnailUrl"
    - from: "apps/web/src/components/ImageGrid.tsx"
      to: "apps/web/src/stores/imageStore.ts"
      via: "reads images array and selection state"
      pattern: "useImageStore"
    - from: "apps/web/src/routes/index.tsx"
      to: "apps/web/src/components"
      via: "imports and renders ImageUpload, ImageGrid, ImageLightbox"
      pattern: "import.*Image(Upload|Grid|Lightbox)"
---

<objective>
Build the three core UI components: drag-drop upload, virtual scrolling image grid, and lightbox preview. Wire them into the home page.

Purpose: Delivers the primary user-facing features — uploading stickers and browsing the collection.
Output: Working upload flow, browsable image grid with virtual scrolling, and full-size preview.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-image-management/02-RESEARCH.md
@.planning/phases/02-image-management/02-01-SUMMARY.md
@.planning/phases/02-image-management/02-02-SUMMARY.md
@apps/web/src/lib/api.ts
@apps/web/src/stores/imageStore.ts
@apps/web/src/routes/index.tsx
@packages/shared/src/image.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install frontend deps and create ImageUpload component</name>
  <files>
    apps/web/package.json
    apps/web/src/components/ImageUpload.tsx
  </files>
  <action>
Install web dependencies: `cd /opt/.openclaw/workspace/external/emohub/apps/web && bun add react-dropzone yet-another-react-lightbox @tanstack/react-virtual`

Create `apps/web/src/components/ImageUpload.tsx`:
- Import { useDropzone } from 'react-dropzone'
- Import { useImageStore } from '@/stores/imageStore'
- Import { imageApi } from '@/lib/api'
- Import { useState, useCallback } from 'react'

Component `ImageUpload`:
- State: `isUploading: boolean`, `results: Array<{ filename: string; duplicate: boolean; error?: string }>`
- useDropzone config:
  - accept: { 'image/jpeg': ['.jpg', '.jpeg'], 'image/png': ['.png'], 'image/webp': ['.webp'], 'image/gif': ['.gif'] }
  - maxSize: 10 * 1024 * 1024 (10MB)
  - onDrop callback: set isUploading true, call imageApi.upload(acceptedFiles), on success call addImages for non-duplicate results, set results array showing which files were duplicates, set isUploading false. On error, set isUploading false and show error in results.
- Render:
  - Dropzone div with dashed border (2px dashed #d1d5db), rounded corners, padding 32px, text-center, cursor pointer
  - When isDragActive: blue border (#3b82f6), light blue background
  - When isUploading: show "Uploading..." with a simple spinner (CSS animation)
  - Default state: icon + "Drag and drop images here, or click to select" text
  - Below dropzone: if results exist, show a results list — green checkmark for successful uploads, yellow warning icon + "duplicate" label for duplicates, red X for errors
  - Results auto-dismiss after 5 seconds (useEffect with setTimeout)
- Style with inline styles or CSS modules — keep it clean and functional, no external CSS framework needed.
  </action>
  <verify>
`cd /opt/.openclaw/workspace/external/emohub/apps/web && bunx vite build` passes. ImageUpload.tsx exists and exports ImageUpload component.
  </verify>
  <done>ImageUpload component renders drag-drop zone, handles file upload via API, shows upload progress and duplicate warnings, adds successful uploads to store.</done>
</task>

<task type="auto">
  <name>Task 2: ImageGrid with virtual scrolling and ImageLightbox</name>
  <files>
    apps/web/src/components/ImageGrid.tsx
    apps/web/src/components/ImageLightbox.tsx
  </files>
  <action>
Create `apps/web/src/components/ImageGrid.tsx`:
- Import { useVirtualizer } from '@tanstack/react-virtual'
- Import { useImageStore } from '@/stores/imageStore'
- Import { imageApi } from '@/lib/api'
- Import { useRef, useState, useEffect, useCallback } from 'react'

Component `ImageGrid`:
- Props: `onImageClick: (index: number) => void`
- Read images, isLoading, selectedIds, toggleSelect from useImageStore
- useEffect on mount: call fetchImages()
- Ref: parentRef for scroll container
- State: columns (number), computed from container width (Math.max(Math.floor(width / 200), 2), recalculate on resize via ResizeObserver)
- Compute rows = Math.ceil(images.length / columns)
- useVirtualizer: count = rows, getScrollElement = parentRef.current, estimateSize = () => 200, overscan = 3
- Render:
  - Scroll container div: ref={parentRef}, height 100%, overflow auto, flex 1
  - If isLoading and no images: show "Loading..." centered
  - If not loading and no images: show "No images yet. Upload some stickers!" centered
  - Virtual container div with getTotalSize() height, position relative
  - For each virtual row: absolute positioned div at virtualRow.start
    - Render columns items: images.slice(rowIndex * columns, rowIndex * columns + columns)
    - Each image: div with thumbnail img (src = imageApi.getThumbnailUrl(image.id)), object-fit cover, 100% width/height
    - onClick: call onImageClick(globalIndex)
    - Selection indicator: if selectedIds.has(image.id), show blue border or checkmark overlay
    - Hover effect: slight scale or opacity change via CSS
  - Grid gap: 8px between items

Create `apps/web/src/components/ImageLightbox.tsx`:
- Import Lightbox from 'yet-another-react-lightbox'
- Import 'yet-another-react-lightbox/styles.css'
- Import { imageApi } from '@/lib/api'
- Import Image type from @emohub/shared

Component `ImageLightbox`:
- Props: `images: Image[]`, `index: number` (-1 means closed), `onClose: () => void`
- Build slides array: images.map(img => ({ src: imageApi.getFullUrl(img.id), alt: img.originalName, width: img.width, height: img.height }))
- Render Lightbox: open={index >= 0}, close={onClose}, index={index}, slides={slides}, carousel={{ finite: false }}, controller={{ closeOnBackdropClick: true }}
  </action>
  <verify>
`cd /opt/.openclaw/workspace/external/emohub/apps/web && bunx vite build` passes. Both components exist and export correctly.
  </verify>
  <done>ImageGrid renders virtual-scrolled grid with dynamic columns, selection indicators, and click-to-preview. ImageLightbox shows full-size images with keyboard navigation.</done>
</task>

<task type="auto">
  <name>Task 3: Wire components into home page</name>
  <files>
    apps/web/src/routes/index.tsx
  </files>
  <action>
Update `apps/web/src/routes/index.tsx`:
- Import ImageUpload, ImageGrid, ImageLightbox from '@/components/*'
- Import { useImageStore } from '@/stores/imageStore'
- Import { useState } from 'react'

HomePage component:
- State: lightboxIndex (number, default -1)
- Read images from useImageStore
- Layout (flexbox column, full height, gap 16px, padding 16px):
  1. ImageUpload at top
  2. ImageGrid taking remaining space (flex: 1), onImageClick sets lightboxIndex
  3. ImageLightbox with images, index=lightboxIndex, onClose sets lightboxIndex to -1
  </action>
  <verify>
`cd /opt/.openclaw/workspace/external/emohub/apps/web && bunx vite build` passes. Home page renders all three components.
  </verify>
  <done>Home page renders upload zone, image grid, and lightbox. Upload adds images to grid. Clicking thumbnail opens lightbox.</done>
</task>

</tasks>

<verification>
- Web app builds without errors
- ImageUpload accepts drag-drop and click-to-select, validates file types and size
- ImageGrid renders thumbnails in virtual-scrolled dynamic-column grid
- Clicking thumbnail opens ImageLightbox with full-size preview
- Lightbox supports keyboard navigation (arrow keys, Escape to close)
- Upload results show duplicate warnings
</verification>

<success_criteria>
Users can upload images via drag-drop, browse them in a performant virtual-scrolled grid, and preview full-size images in a lightbox. Core browsing and upload experience is complete.
</success_criteria>

<output>
After completion, create `.planning/phases/02-image-management/02-03-SUMMARY.md`
</output>
